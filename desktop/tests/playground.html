<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Blockly Playground</title>

  <!-- Stylesheet links -->
  <link rel="stylesheet" type="text/css" href="playground.css">

  <!-- Including JS files for blockly -->
  <script src="../blockly_uncompressed.js"></script>
  <script src="../generators/c.js"></script> <!-- custom -->
  <script src="../generators/c/arduino.js"></script> <!-- custom -->
  <script src="../generators/c/arduino_eeprom.js"></script> <!-- custom -->
  <script src="../generators/c/arduino_pwm.js"></script> <!-- custom -->
  <script src="../generators/c/arduino_serial.js"></script> <!-- custom -->
  <script src="../generators/c/arduino_servo.js"></script> <!-- custom -->
  <script src="../generators/c/arrays.js"></script> <!-- custom -->
  <script src="../generators/c/colour.js"></script> <!-- custom -->
  <script src="../generators/c/lists.js"></script> <!-- custom -->
  <script src="../generators/c/logic.js"></script> <!-- custom -->
  <script src="../generators/c/loops.js"></script> <!-- custom -->
  <script src="../generators/c/math.js"></script> <!-- custom -->
  <script src="../generators/c/procedures.js"></script> <!-- custom -->
  <script src="../generators/c/ringo.js"></script> <!-- custom -->
  <script src="../generators/c/text.js"></script> <!-- custom -->
  <script src="../generators/c/variables.js"></script> <!-- custom -->
  <script src="../generators/c/wink.js"></script> <!-- custom -->
  <script src="../generators/dart.js"></script>
  <script src="../generators/dart/logic.js"></script>
  <script src="../generators/dart/loops.js"></script>
  <script src="../generators/dart/math.js"></script>
  <script src="../generators/dart/text.js"></script>
  <script src="../generators/dart/lists.js"></script>
  <script src="../generators/dart/colour.js"></script>
  <script src="../generators/dart/variables.js"></script>
  <script src="../generators/dart/procedures.js"></script>
  <script src="../generators/javascript.js"></script>
  <script src="../generators/javascript/classes.js"></script> <!-- custom -->
  <script src="../generators/javascript/colour.js"></script>
  <script src="../generators/javascript/dom.js"></script> <!-- custom -->
  <script src="../generators/javascript/eval.js"></script> <!-- custom -->
  <script src="../generators/javascript/lists.js"></script>
  <script src="../generators/javascript/logic.js"></script>
  <script src="../generators/javascript/loops.js"></script>
  <script src="../generators/javascript/math.js"></script>
  <script src="../generators/javascript/phaser.js"></script> <!-- custom -->
  <script src="../generators/javascript/procedures.js"></script>
  <script src="../generators/javascript/text.js"></script>
  <script src="../generators/javascript/variables.js"></script>
  <script src="../generators/lua.js"></script>
  <script src="../generators/lua/logic.js"></script>
  <script src="../generators/lua/loops.js"></script>
  <script src="../generators/lua/math.js"></script>
  <script src="../generators/lua/text.js"></script>
  <script src="../generators/lua/lists.js"></script>
  <script src="../generators/lua/colour.js"></script>
  <script src="../generators/lua/variables.js"></script>
  <script src="../generators/lua/procedures.js"></script>
  <script src="../generators/php.js"></script>
  <script src="../generators/php/logic.js"></script>
  <script src="../generators/php/loops.js"></script>
  <script src="../generators/php/math.js"></script>
  <script src="../generators/php/text.js"></script>
  <script src="../generators/php/lists.js"></script>
  <script src="../generators/php/colour.js"></script>
  <script src="../generators/php/variables.js"></script>
  <script src="../generators/php/procedures.js"></script>
  <script src="../generators/python.js"></script>
  <script src="../generators/python/logic.js"></script>
  <script src="../generators/python/loops.js"></script>
  <script src="../generators/python/math.js"></script>
  <script src="../generators/python/text.js"></script>
  <script src="../generators/python/lists.js"></script>
  <script src="../generators/python/colour.js"></script>
  <script src="../generators/python/variables.js"></script>
  <script src="../generators/python/procedures.js"></script>

  <script src="../msg/messages.js"></script>

  <script src="../blocks/arduino.js"></script> <!-- custom -->
  <script src="../blocks/arduino_eeprom.js"></script> <!-- custom -->
  <script src="../blocks/arduino_pwm.js"></script> <!-- custom -->
  <script src="../blocks/arduino_serial.js"></script> <!-- custom -->
  <script src="../blocks/arduino_servo.js"></script> <!-- custom -->
  <script src="../blocks/classes.js"></script> <!-- custom -->
  <script src="../blocks/colour.js"></script>
  <script src="../blocks/dom.js"></script> <!-- custom -->
  <script src="../blocks/dragondropdom.js"></script> <!-- custom -->
  <script src="../blocks/eval.js"></script> <!-- custom -->
  <script src="../blocks/lists.js"></script>
  <script src="../blocks/logic.js"></script>
  <script src="../blocks/loops.js"></script>
  <script src="../blocks/math.js"></script>
  <script src="../blocks/phaser.js"></script>
  <script src="../blocks/procedures.js"></script>
  <script src="../blocks/procedures_typed.js"></script> <!-- custom -->
  <script src="../blocks/ringo.js"></script> <!-- custom -->
  <script src="../blocks/text.js"></script>
  <script src="../blocks/typedarrays.js"></script> <!-- custom -->
  <script src="../blocks/variables.js"></script>
  <script src="../blocks/wink.js"></script> <!-- custom -->

<!-- Script loading and resources -->
<script src="../static/jquery-3.2.1.min.js"></script>
<script type="text/javascript">
    'use strict';

    // Global variables
    var workspace = null;   // The workspace representing blockly.
    var fakeDragStack = []; // Holds the queued fake drags that will occur after creation.
    var numDrags = 0;       // Tracks number of automatic drags performed.
    var isVisible = true;   // Can we see the blockly workspace/ is it rendered? True by default.

    // Parses out the toolboxes and associates them with a name. 
    // Toolbox load order isn't guarenteed, but toolboxes will load before blockly does.
    function parseToolboxes() {
      const promises = [];
      promises.push(parseToolbox("wink", "../project_types/exploring_wink_robot/static/toolbox.xml"));
      promises.push(parseToolbox("phaser", "../project_types/visual_phaser/static/toolbox.xml"));
      promises.push(parseToolbox("arduino", "../project_types/arduino/static/toolbox.xml"));
      promises.push(parseToolbox("exploring_phaser", "../project_types/exploring_phaser/static/toolbox.xml"));
      promises.push(parseToolbox("exploring_wink", "../project_types/exploring_wink_robot/static/toolbox.xml"));
      return Promise.all(promises);
    }

    // Captues and writes error messages out to the console
    function logErr(message) {
      document.getElementById('dd-log').innerHTML 
      = document.getElementById('dd-log').innerHTML + "[ERR] " + message + "\n";
      //+ '<div class="dd-output-err"><code>' + toStr(message) + '</code></div>';
    }

    // Captues and writes general logging messages out to the console
    function logLine(message) {
      document.getElementById('dd-log').innerHTML 
      = document.getElementById('dd-log').innerHTML + "[Log] " + message + "\n";
      //+ '<div class="dd-output-log"><code>' + toStr(message) + '</code></div>';
    }

    // Forces the log div to scroll automatically as more things are added.
    function scrollLog() {
      $('#dd-log').scrollTop($('#dd-log')[0].scrollHeight - $('#dd-log')[0].clientHeight);
    }

    // Intercept the console logging for errors, warnings, and logs. We then hand it to our
    // logging functions, but make sure we rebind the console to each thing so we still get
    // stuff in the broswer console.
    ['log','warn','error'].forEach(function (verb) {
      console[verb] = (function (method, verb) {
        return function(text) {
          if(verb == "error")
            logErr(text);
          else
            logLine(text);  
          scrollLog();
        };
      })
      (console[verb].bind(console), verb);
    });

    // Catch errors and pass them off to logging. 
    window.onerror = function(err) {
        console.error(err);
    };

    // Document initialization, steps enforced with promises.
    $(document).ready(function(){
      parseToolboxes().then(initializeBlockly);
    });

    // Parses the specified toolbox and appends it to the document.
    // Toolbox IDs are set to "toolbox-" + toolbox_name
    function parseToolbox(toolbox_name, file_path) {
      return new Promise((resolve, reject) => {
        $.ajax({
          type: "GET",
          url: file_path,
          dataType: "xml",
          success: (xml) => { 
            ParseInternal(xml, toolbox_name); 
            console.log("Parsed toolbox-" + toolbox_name);
            document.getElementById("which-toolbox").innerHTML = document.getElementById("which-toolbox").innerHTML + '<option value="' + toolbox_name + '">' + toolbox_name + '</option>';
            resolve();
          }
        }).fail(function() {
            console.log("FAILED TO PARSE " + toolbox_name + " AT " + file_path);
            reject();
        })
      });


      // Parses the XML, adjusts name, and appends it to the document.
      function ParseInternal(xml, name) {
        // Create a new XML element, fill the internals with the xml,
        // and set the attributes for it accordingly.
        let e = document.createElement("xml");
        e.innerHTML = xml.childNodes[0].innerHTML;
        e.setAttribute("id", "toolbox-" + name);
        e.setAttribute("style","display: none");

        // Append the XML to the document body.
        document.body.appendChild(e);
      }
    }

    // Javascript object printing with pretty-print
    function toStr(obj) {
      return JSON.stringify(obj, null, 2);
    }

    // Sets an attribute in all tags with the specified name on an XML document.
    // It's the more general version of the following example line:
    // xml.getElementsByTagName("xml")[0].attributes[0].textContent = name;
    function setAttrInTags(xml, xml_tag, attr_name, new_value) {
      const elements = xml.getElementsByTagName(xml_tag);
      for(let i = 0; i < elements.length; i += 1) {

        const attributes = xml.getElementsByTagName(xml_tag)[i].attributes;
        for(let j = 0; j < attributes.length; j += 1) {

          const name = xml.getElementsByTagName(xml_tag)[i].attributes[j].name;
          if(name == attr_name) {
            xml.getElementsByTagName(xml_tag)[i].attributes[j].textContent = new_value;
          }
        }
      }
    }

    // The start of the application. This parses URL arguments and whatnot, arranging blockly.
    function initializeBlockly() {
        // Parse the URL arguments.
        var match = location.search.match(/dir=([^&]+)/);
        var rtl = match && match[1] == 'rtl';
        document.forms.options.elements.dir.selectedIndex = Number(rtl);
        var toolbox = getToolboxElement();
        document.forms.options.elements.toolbox.selectedIndex = 0;
        //Number(toolbox.getElementsByTagName('simple').length == 0);
        match = location.search.match(/side=([^&]+)/);
        var side = match ? match[1] : 'start';
        document.forms.options.elements.side.value = side;
        // Create main workspace.
        workspace = Blockly.inject('blocklyDiv',
            {comments: true,
                disable: true,
                collapse: true,
                grid:
                    {spacing: 25,
                        length: 3,
                        colour: '#ccc',
                        snap: true},
                horizontalLayout: side == 'top' || side == 'bottom',
                maxBlocks: Infinity,
                media: '../media/',
                readOnly: false,
                rtl: rtl,
                scrollbars: true,
                toolbox: toolbox,
                toolboxPosition: side == 'top' || side == 'start' ? 'start' : 'end',
                zoom:
                    {controls: true,
                        wheel: true,
                        startScale: 1.0,
                        maxScale: 4,
                        minScale: .25,
                        scaleSpeed: 1.1}
            });
        // Restore previously displayed text.
        if (sessionStorage) {
            var text = sessionStorage.getItem('textarea');
            if (text) {
                document.getElementById('importExport').value = text;
            }
            // Restore event logging state.
            var state = sessionStorage.getItem('logEvents');
            logEvents(Boolean(Number(state)));
        } else {
            // MSIE 11 does not support sessionStorage on file:// URLs.
            logEvents(false);
        }
        taChange();
    }

    function getToolboxElement() {
        let which = document.getElementById("which-toolbox");
        return document.getElementById("toolbox-" + which.options[which.selectedIndex].value);
    }

    function toXml() {
        var output = document.getElementById('importExport');
        var xml = Blockly.Xml.workspaceToDom(workspace);
        output.value = Blockly.Xml.domToPrettyText(xml);
        output.focus();
        output.select();
        taChange();
    }

    function fromXml() {
        var input = document.getElementById('importExport');
        var xml = Blockly.Xml.textToDom(input.value);
        Blockly.Xml.domToWorkspace(xml, workspace);
        taChange();
    }

    function toCode(lang) {
        var output = document.getElementById('importExport');
        output.value = Blockly[lang].workspaceToCode(workspace);
        taChange();
    }

    // Disable the "Import from XML" button if the XML is invalid.
    // Preserve text between page reloads.
    function taChange() {
        var textarea = document.getElementById('importExport');
        if (sessionStorage) {
            sessionStorage.setItem('textarea', textarea.value);
        }
        var valid = true;
        try {
            Blockly.Xml.textToDom(textarea.value);
        } catch (e) {
            valid = false;
        }
        document.getElementById('import').disabled = !valid;
    }

    function logEvents(state) {
        var checkbox = document.getElementById('logCheck');
        checkbox.checked = state;
        if (sessionStorage) {
            sessionStorage.setItem('logEvents', Number(state));
        }
        if (state) {
            workspace.addChangeListener(logger);
        } else {
            workspace.removeChangeListener(logger);
        }
    }

    function logger(e) {
        console.log(e);
    }

    function toggleWorkspaceVisibility() {
      isVisible = !isVisible;
      workspace.setVisible(isVisible);
    }
    
    function cleanReload() {
      console.log("Reloading workspace");
      $( '.injectionDiv' ).remove();
      let toolbox = getToolboxElement();
      let match = location.search.match(/dir=([^&]+)/);
      let rtl = match && match[1] == 'rtl';
      match = location.search.match(/side=([^&]+)/);
      let side = match ? match[1] : 'start';
      document.forms.options.elements.side.value = side;
      workspace = Blockly.inject('blocklyDiv',
          {comments: true,
              disable: true,
              collapse: true,
              grid:
                  {spacing: 25,
                      length: 3,
                      colour: '#ccc',
                      snap: true},
              horizontalLayout: side == 'top' || side == 'bottom',
              maxBlocks: Infinity,
              media: '../media/',
              readOnly: false,
              rtl: rtl,
              scrollbars: true,
              toolbox: toolbox,
              toolboxPosition: side == 'top' || side == 'start' ? 'start' : 'end',
              zoom:
                  {controls: true,
                      wheel: true,
                      startScale: 1.0,
                      maxScale: 4,
                      minScale: .25,
                      scaleSpeed: 1.1}
          });
    }

    function airstrike(n) {
        console.log("Placing " + n + " random blocks");
        var prototypes = [];
        var toolbox = getToolboxElement();
        var blocks = toolbox.getElementsByTagName('block');
        for (let i = 0, block; block = blocks[i]; i++) {
            prototypes.push(block.getAttribute('type'));
        }
        for (var i = 0; i < n; i++) {
            var prototype = prototypes[Math.floor(Math.random() * prototypes.length)];
            var block = workspace.newBlock(prototype);
            block.initSvg();
            block.getSvgRoot().setAttribute('transform', 'translate(' +
                Math.round(Math.random() * 450 + 40) + ', ' +
                Math.round(Math.random() * 600 + 40) + ')');
            block.render();
        }
    }

    function fakeDrag(id, dx, dy, opt_workspace) {
        var ws = opt_workspace || Blockly.getMainWorkspace();
        var blockToDrag = ws.getBlockById(id);

        if (!blockToDrag) {
            fakeDragWrapper();
            return;
        }
        var blockTop = blockToDrag.svgGroup_.getBoundingClientRect().top;
        var blockLeft = blockToDrag.svgGroup_.getBoundingClientRect().left;

        // Click somewhere on the block.
        var mouseDownEvent = new MouseEvent('mousedown',
            {clientX: blockLeft + 5, clientY: blockTop + 5});
        blockToDrag.onMouseDown_(mouseDownEvent);

        // Throw in a move for good measure.
        setTimeout(
            function() {
                var mouseMoveEvent = new MouseEvent('mousemove',
                    {clientX: blockLeft + dx,
                        clientY: blockTop + dy});
                blockToDrag.onMouseMove_(mouseMoveEvent);

                // Drop at dx, dy.
                setTimeout(
                    function() {
                        var mouseUpEvent = new MouseEvent('mouseup',
                            {clientX: blockLeft + dx,
                                clientY: blockTop + dy});
                        blockToDrag.onMouseUp_(mouseUpEvent);

                        setTimeout(fakeDragWrapper(), 100);
                    }, 30);
            }, 30);
    }

    function fakeDragWrapper() {
        var dragInfo = fakeDragStack.pop();

        // Track number of drags for debug output.
        numDrags += 1;
        if(numDrags % 100 == 0)
            console.log(numDrags + " drags have been performed so far...")

        if (dragInfo) {
            fakeDrag(dragInfo.id, dragInfo.dx, dragInfo.dy, dragInfo.workspace);
        }
        else
            console.log("Finsihed " + numDrags + " drags")

    }

    function fakeManyDrags() {
        var blockList = workspace.getAllBlocks();
        const drags = 5 * blockList.length;

        // Log output
        console.log("Performing " + drags + " drags");
        numDrags = 0;

        for (let i = 0; i < drags; i++) {
            fakeDragStack.push(
                {
                    id: blockList[Math.round(Math.random() * (blockList.length - 1))].id,
                    // Move some blocks up and to the left, but mostly down and to the right.
                    dx: Math.round((Math.random() - 0.25) * 200),
                    dy: Math.round((Math.random() - 0.25) * 200),
                    workspace: workspace
                });
        }
        fakeDragWrapper();
    }

    function spaghetti(n) {
        var xml = spaghettiXml;
        for(var i = 0; i < n; i++) {
            xml = xml.replace(/(<(statement|next)( name="DO0")?>)<\//g,
                '$1' + spaghettiXml + '</');
        }
        xml = '<xml xmlns="http://www.w3.org/1999/xhtml">' + xml + '</xml>';
        var dom = Blockly.Xml.textToDom(xml);
        console.time('Spaghetti domToWorkspace');
        Blockly.Xml.domToWorkspace(dom, workspace);
        console.timeEnd('Spaghetti domToWorkspace');
    }
    var spaghettiXml = [
        '  <block type="controls_if">',
        '    <value name="IF0">',
        '      <block type="logic_compare">',
        '        <field name="OP">EQ</field>',
        '        <value name="A">',
        '          <block type="math_arithmetic">',
        '            <field name="OP">MULTIPLY</field>',
        '            <value name="A">',
        '              <block type="math_number">',
        '                <field name="NUM">6</field>',
        '              </block>',
        '            </value>',
        '            <value name="B">',
        '              <block type="math_number">',
        '                <field name="NUM">7</field>',
        '              </block>',
        '            </value>',
        '          </block>',
        '        </value>',
        '        <value name="B">',
        '          <block type="math_number">',
        '            <field name="NUM">42</field>',
        '          </block>',
        '        </value>',
        '      </block>',
        '    </value>',
        '    <statement name="DO0"></statement>',
        '    <next></next>',
        '  </block>'].join('\n');

    function placeAll() {
        var prototypes = [];
        var toolbox = getToolboxElement();
        var blocks = toolbox.getElementsByTagName('block');
        for (let i = 0, block; block = blocks[i]; i++) {
            prototypes.push(block.getAttribute('type'));
        }

        for (var i = 0; i < prototypes.length; i++) {
            var prototype = prototypes[i];
            var block = workspace.newBlock(prototype);
            block.initSvg();
            block.getSvgRoot().setAttribute('transform', 'translate(' +
                Math.round(Math.random() * 40 + 20) + ', ' +
                Math.round(Math.random() * 40 + i * 10) + ')');
            block.render();
        }
    }
</script>

</head>
<html>
<body>

  <div id="blocklyDiv"></div>

  <h1>Blockly Playground</h1>

  <p class="dd-center">
    <a href="javascript:void(toggleWorkspaceVisibility())">Toggle Visibility</a>
  </p>

  <form id="options">
    Toolbox: 
    <select id="which-toolbox" name="toolbox" onchange="return cleanReload();"></select>
    <br/>

    Text Alignment: 
    <select name="dir" onchange="document.forms.options.submit()">
      <option value="ltr">LTR</option>
      <option value="rtl">RTL</option>
    </select> 
    <br/>

    Dropdown Position: 
    <select name="side" onchange="document.forms.options.submit()">
      <option value="start">Start</option>
      <option value="end">End</option>
      <option value="top">Top</option>
      <option value="bottom">Bottom</option>
    </select>
  </form>

  <p>
    <input type="button" value="Export to XML" onclick="toXml()">
    &nbsp;
    <input type="button" value="Import from XML" onclick="fromXml()" id="import">
    <br>
    <input type="button" value="To JavaScript" onclick="toCode('JavaScript')">
    &nbsp;
    <input type="button" value="To C" onclick="toCode('C')">
    &nbsp;
    <input type="button" value="To Python" onclick="toCode('Python')">
    &nbsp;
    <input type="button" value="To PHP" onclick="toCode('PHP')">
    &nbsp;
    <input type="button" value="To Lua" onclick="toCode('Lua')">
    &nbsp;
    <input type="button" value="To Dart" onclick="toCode('Dart')">
    <br>
    <textarea id="importExport" style=""
      onchange="taChange();" onkeyup="taChange()"></textarea>
  </p>
  <h2>
    Stress test
  </h2>

  <p>
    <input type="button" value="Airstrike!" onclick="airstrike(100)">
    <br/><input type="button" value="Spaghetti!" onclick="spaghetti(8)">
    <br/><input type="button" value="Fake some drags!" onclick="fakeManyDrags()">
    <br/><input type="button" value="Make ALL the blocks!" onclick="placeAll()">
  </p>
<hr/>
  <h2>
    Output
  </h2>
  <p>
    <input type="checkbox" onclick="logEvents(this.checked)" id="logCheck" > Log block events
  </p>
  <hr/>
    <textarea id="dd-log" readonly="true"></textarea>
  <hr/>
</body>

</html>
