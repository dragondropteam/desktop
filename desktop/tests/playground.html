<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Blockly Playground</title>
  <!--xml src="simple.xml" type="text/xmldata" id="toolbox-simple" ></xml-->
  <script src="../blockly_uncompressed.js"></script>

  <script src="../generators/javascript.js"></script>
  <script src="../generators/javascript/classes.js"></script> <!-- custom -->
  <script src="../generators/javascript/colour.js"></script>
  <script src="../generators/javascript/dom.js"></script> <!-- custom -->
  <script src="../generators/javascript/eval.js"></script> <!-- custom -->
  <script src="../generators/javascript/lists.js"></script>
  <script src="../generators/javascript/logic.js"></script>
  <script src="../generators/javascript/loops.js"></script>
  <script src="../generators/javascript/math.js"></script>
  <script src="../generators/javascript/phaser.js"></script> <!-- custom -->
  <script src="../generators/javascript/procedures.js"></script>
  <script src="../generators/javascript/text.js"></script>
  <script src="../generators/javascript/variables.js"></script>

  <script src="../generators/python.js"></script>
  <script src="../generators/python/logic.js"></script>
  <script src="../generators/python/loops.js"></script>
  <script src="../generators/python/math.js"></script>
  <script src="../generators/python/text.js"></script>
  <script src="../generators/python/lists.js"></script>
  <script src="../generators/python/colour.js"></script>
  <script src="../generators/python/variables.js"></script>
  <script src="../generators/python/procedures.js"></script>
  <script src="../generators/php.js"></script>
  <script src="../generators/php/logic.js"></script>
  <script src="../generators/php/loops.js"></script>
  <script src="../generators/php/math.js"></script>
  <script src="../generators/php/text.js"></script>
  <script src="../generators/php/lists.js"></script>
  <script src="../generators/php/colour.js"></script>
  <script src="../generators/php/variables.js"></script>
  <script src="../generators/php/procedures.js"></script>
  <script src="../generators/lua.js"></script>
  <script src="../generators/lua/logic.js"></script>
  <script src="../generators/lua/loops.js"></script>
  <script src="../generators/lua/math.js"></script>
  <script src="../generators/lua/text.js"></script>
  <script src="../generators/lua/lists.js"></script>
  <script src="../generators/lua/colour.js"></script>
  <script src="../generators/lua/variables.js"></script>
  <script src="../generators/lua/procedures.js"></script>
  <script src="../generators/dart.js"></script>
  <script src="../generators/dart/logic.js"></script>
  <script src="../generators/dart/loops.js"></script>
  <script src="../generators/dart/math.js"></script>
  <script src="../generators/dart/text.js"></script>
  <script src="../generators/dart/lists.js"></script>
  <script src="../generators/dart/colour.js"></script>
  <script src="../generators/dart/variables.js"></script>
  <script src="../generators/dart/procedures.js"></script>
  <script src="../msg/messages.js"></script>

  <!-- ORIGINAL -->
  <!--script src="../blocks/phaser.js"></script>
  <script src="../blocks/logic.js"></script>
  <script src="../blocks/loops.js"></script>
  <script src="../blocks/math.js"></script>
  <script src="../blocks/text.js"></script>
  <script src="../blocks/lists.js"></script>
  <script src="../blocks/colour.js"></script>
  <script src="../blocks/variables.js"></script>
  <script src="../blocks/procedures.js"></script-->

  <!-- CUSTOM -->
  <script src="../blocks/arduino.js"></script>
  <script src="../blocks/arduino_eeprom.js"></script>
  <script src="../blocks/arduino_pwm.js"></script>
  <script src="../blocks/arduino_serial.js"></script>
  <script src="../blocks/arduino_servo.js"></script>
  <script src="../blocks/classes.js"></script>
  <script src="../blocks/colour.js"></script>
  <script src="../blocks/dom.js"></script>
  <script src="../blocks/dragondropdom.js"></script>
  <script src="../blocks/eval.js"></script>
  <script src="../blocks/lists.js"></script>
  <script src="../blocks/logic.js"></script>
  <script src="../blocks/loops.js"></script>
  <script src="../blocks/math.js"></script>
  <script src="../blocks/phaser.js"></script>
  <script src="../blocks/procedures.js"></script>
  <script src="../blocks/procedures_typed.js"></script>
  <script src="../blocks/ringo.js"></script>
  <script src="../blocks/text.js"></script>
  <script src="../blocks/typedarrays.js"></script>
  <script src="../blocks/variables.js"></script>
  <script src="../blocks/wink.js"></script>

<!-- Script loading and resources -->
<script src="../static/jquery-3.2.1.min.js"></script>
<script type="text/javascript">
    'use strict';
    var workspace = null;
    var fakeDragStack = [];
    var numDrags = 0;

    function logErr(message) {
      document.getElementById('dd-log').innerHTML 
      = document.getElementById('dd-log').innerHTML 
      + '<div style="background-color: rgb(255, 200, 200); padding: 2px; border-bottom: 1px rgb(210, 210, 220) solid;"><code>'
      + toStr(message) 
      + '</code></div>'
    }

    function logLine(message) {
      document.getElementById('dd-log').innerHTML 
      = document.getElementById('dd-log').innerHTML 
      + '<div style="background-color: rgb(250, 250, 252); padding: 2px; border-bottom: 1px rgb(210, 210, 220) solid;"><code>'
      + toStr(message) 
      + '</code></div>'
    }

    function scrollLog() {
      $('#dd-log').scrollTop($('#dd-log')[0].scrollHeight - $('#dd-log')[0].clientHeight);
    }

    // Step in and nab the console log and console error output so we can
    // feed them to the screen as well. 
    (function(){
      console.log("Configuring Output");
      var oldLog = console.log;
      console.log = function (message) {
          logLine(message);
          scrollLog();
          oldLog.apply(console, arguments);
      };
      var oldErr = console.error;
      console.error = function (message) {
          logErr(message);
          scrollLog();
          oldErr.apply(console, Array.prototype.slice.call(arguments).join(' '));
      };
    })();

    (function(){

    })();

    // Place new toolboxes to parse in here
    $(document).ready(function(){
      parseToolbox("phaser", "../project_types/visual_phaser/static/toolbox.xml");
      //parseToolbox("simple", "../project_types/visual_phaser/static/toolbox.xml");


      // Intercept console information from the webpage to add to output.

    });

    // Parses the specified toolbox and appends it to the document.
    // Toolbox IDs are set to "toolbox-" + toolbox_name
    function parseToolbox(toolbox_name, file_path) {
      console.log("Parsing toolbox: " + toolbox_name)
      $.ajax({
        type: "GET",
        url: file_path,
        dataType: "xml",
        success: (xml) => { ParseInternal(xml, toolbox_name); }
      }).done(function(a, b) {
          console.log( "done a: " + toStr(a) + " b: " + toStr(b) );
      })
      .fail(function(a, b) {
          console.error( "error a: " + toStr(a) + " b: " + toStr(b) );
      })
      .always(function(a, b) {
          console.log( "always a: " + toStr(a) + " b: " + toStr(b) );
      });

      // Parses the XML, adjusts name, and appends it to the document.
      function ParseInternal(xml, name) {
        // Create a new XML element, fill the internals with the xml,
        // and set the attributes for it accordingly.
        let e = document.createElement("xml");
        e.innerHTML = xml.childNodes[0].innerHTML;
        e.setAttribute("id", "toolbox-" + name);
        e.setAttribute("style","display: none");
        console.log(e);

        // Append the XML to the document body.
        document.body.appendChild(e);
      }
    }

    // Javascript object printing with pretty-print
    function toStr(obj) {
      return JSON.stringify(obj, null, 2);
    }

    // Sets an attribute in all tags with the specified name on an XML document.
    // It's the more general version of the following example line:
    // xml.getElementsByTagName("xml")[0].attributes[0].textContent = name;
    function setAttrInTags(xml, xml_tag, attr_name, new_value) {
      const elements = xml.getElementsByTagName(xml_tag);
      for(let i = 0; i < elements.length; i += 1) {

        const attributes = xml.getElementsByTagName(xml_tag)[i].attributes;
        for(let j = 0; j < attributes.length; j += 1) {

          const name = xml.getElementsByTagName(xml_tag)[i].attributes[j].name;
          if(name == attr_name) {
            xml.getElementsByTagName(xml_tag)[i].attributes[j].textContent = new_value;
          }
        }
      }
    }

    // The start of the application. This parses URL arguments and whatnot, arranging blockly.
    function start() {
        // Parse the URL arguments.
        var match = location.search.match(/dir=([^&]+)/);
        var rtl = match && match[1] == 'rtl';
        document.forms.options.elements.dir.selectedIndex = Number(rtl);
        var toolbox = getToolboxElement();
        document.forms.options.elements.toolbox.selectedIndex = 0;
        //Number(toolbox.getElementsByTagName('simple').length == 0);
        match = location.search.match(/side=([^&]+)/);
        var side = match ? match[1] : 'start';
        document.forms.options.elements.side.value = side;
        // Create main workspace.
        workspace = Blockly.inject('blocklyDiv',
            {comments: true,
                disable: true,
                collapse: true,
                grid:
                    {spacing: 25,
                        length: 3,
                        colour: '#ccc',
                        snap: true},
                horizontalLayout: side == 'top' || side == 'bottom',
                maxBlocks: Infinity,
                media: '../media/',
                readOnly: false,
                rtl: rtl,
                scrollbars: true,
                toolbox: toolbox,
                toolboxPosition: side == 'top' || side == 'start' ? 'start' : 'end',
                zoom:
                    {controls: true,
                        wheel: true,
                        startScale: 1.0,
                        maxScale: 4,
                        minScale: .25,
                        scaleSpeed: 1.1}
            });
        // Restore previously displayed text.
        if (sessionStorage) {
            var text = sessionStorage.getItem('textarea');
            if (text) {
                document.getElementById('importExport').value = text;
            }
            // Restore event logging state.
            var state = sessionStorage.getItem('logEvents');
            logEvents(Boolean(Number(state)));
        } else {
            // MSIE 11 does not support sessionStorage on file:// URLs.
            logEvents(false);
        }
        taChange();
    }

    function getToolboxElement() {
        //var match = location.search.match('toolbox-simple');///toolbox=([^&]+)/);
        return document.getElementById('toolbox-phaser');//document.getElementById('toolbox' + (match ? match[1] : 'categories'));
    }

    function toXml() {
        var output = document.getElementById('importExport');
        var xml = Blockly.Xml.workspaceToDom(workspace);
        output.value = Blockly.Xml.domToPrettyText(xml);
        output.focus();
        output.select();
        taChange();
    }

    function fromXml() {
        var input = document.getElementById('importExport');
        var xml = Blockly.Xml.textToDom(input.value);
        Blockly.Xml.domToWorkspace(xml, workspace);
        taChange();
    }

    function toCode(lang) {
        var output = document.getElementById('importExport');
        output.value = Blockly[lang].workspaceToCode(workspace);
        taChange();
    }

    // Disable the "Import from XML" button if the XML is invalid.
    // Preserve text between page reloads.
    function taChange() {
        var textarea = document.getElementById('importExport');
        if (sessionStorage) {
            sessionStorage.setItem('textarea', textarea.value);
        }
        var valid = true;
        try {
            Blockly.Xml.textToDom(textarea.value);
        } catch (e) {
            valid = false;
        }
        document.getElementById('import').disabled = !valid;
    }

    function logEvents(state) {
        var checkbox = document.getElementById('logCheck');
        checkbox.checked = state;
        if (sessionStorage) {
            sessionStorage.setItem('logEvents', Number(state));
        }
        if (state) {
            workspace.addChangeListener(logger);
        } else {
            workspace.removeChangeListener(logger);
        }
    }

    function logger(e) {
        console.log(e);
    }

    function airstrike(n) {
        console.log("Placing " + n + " random blocks");
        var prototypes = [];
        var toolbox = getToolboxElement();
        var blocks = toolbox.getElementsByTagName('block');
        for (let i = 0, block; block = blocks[i]; i++) {
            prototypes.push(block.getAttribute('type'));
        }
        for (var i = 0; i < n; i++) {
            var prototype = prototypes[Math.floor(Math.random() * prototypes.length)];
            var block = workspace.newBlock(prototype);
            block.initSvg();
            block.getSvgRoot().setAttribute('transform', 'translate(' +
                Math.round(Math.random() * 450 + 40) + ', ' +
                Math.round(Math.random() * 600 + 40) + ')');
            block.render();
        }
    }

    function fakeDrag(id, dx, dy, opt_workspace) {
        var ws = opt_workspace || Blockly.getMainWorkspace();
        var blockToDrag = ws.getBlockById(id);

        if (!blockToDrag) {
            fakeDragWrapper();
            return;
        }
        var blockTop = blockToDrag.svgGroup_.getBoundingClientRect().top;
        var blockLeft = blockToDrag.svgGroup_.getBoundingClientRect().left;

        // Click somewhere on the block.
        var mouseDownEvent = new MouseEvent('mousedown',
            {clientX: blockLeft + 5, clientY: blockTop + 5});
        blockToDrag.onMouseDown_(mouseDownEvent);

        // Throw in a move for good measure.
        setTimeout(
            function() {
                var mouseMoveEvent = new MouseEvent('mousemove',
                    {clientX: blockLeft + dx,
                        clientY: blockTop + dy});
                blockToDrag.onMouseMove_(mouseMoveEvent);

                // Drop at dx, dy.
                setTimeout(
                    function() {
                        var mouseUpEvent = new MouseEvent('mouseup',
                            {clientX: blockLeft + dx,
                                clientY: blockTop + dy});
                        blockToDrag.onMouseUp_(mouseUpEvent);

                        setTimeout(fakeDragWrapper(), 100);
                    }, 30);
            }, 30);
    }

    function fakeDragWrapper() {
        var dragInfo = fakeDragStack.pop();

        // Track number of drags for debug output.
        numDrags += 1;
        if(numDrags % 100 == 0)
            console.log(numDrags + " drags have been performed so far...")

        if (dragInfo) {
            fakeDrag(dragInfo.id, dragInfo.dx, dragInfo.dy, dragInfo.workspace);
        }
        else
            console.log("Finsihed " + numDrags + " drags")

    }

    function fakeManyDrags() {
        var blockList = workspace.getAllBlocks();
        const drags = 5 * blockList.length;

        // Log output
        console.log("Performing " + drags + " drags");
        numDrags = 0;

        for (let i = 0; i < drags; i++) {
            fakeDragStack.push(
                {
                    id: blockList[Math.round(Math.random() * (blockList.length - 1))].id,
                    // Move some blocks up and to the left, but mostly down and to the right.
                    dx: Math.round((Math.random() - 0.25) * 200),
                    dy: Math.round((Math.random() - 0.25) * 200),
                    workspace: workspace
                });
        }
        fakeDragWrapper();
    }

    function spaghetti(n) {
        var xml = spaghettiXml;
        for(var i = 0; i < n; i++) {
            xml = xml.replace(/(<(statement|next)( name="DO0")?>)<\//g,
                '$1' + spaghettiXml + '</');
        }
        xml = '<xml xmlns="http://www.w3.org/1999/xhtml">' + xml + '</xml>';
        var dom = Blockly.Xml.textToDom(xml);
        console.time('Spaghetti domToWorkspace');
        Blockly.Xml.domToWorkspace(dom, workspace);
        console.timeEnd('Spaghetti domToWorkspace');
    }
    var spaghettiXml = [
        '  <block type="controls_if">',
        '    <value name="IF0">',
        '      <block type="logic_compare">',
        '        <field name="OP">EQ</field>',
        '        <value name="A">',
        '          <block type="math_arithmetic">',
        '            <field name="OP">MULTIPLY</field>',
        '            <value name="A">',
        '              <block type="math_number">',
        '                <field name="NUM">6</field>',
        '              </block>',
        '            </value>',
        '            <value name="B">',
        '              <block type="math_number">',
        '                <field name="NUM">7</field>',
        '              </block>',
        '            </value>',
        '          </block>',
        '        </value>',
        '        <value name="B">',
        '          <block type="math_number">',
        '            <field name="NUM">42</field>',
        '          </block>',
        '        </value>',
        '      </block>',
        '    </value>',
        '    <statement name="DO0"></statement>',
        '    <next></next>',
        '  </block>'].join('\n');

    function placeAll() {
        var prototypes = [];
        var toolbox = getToolboxElement();
        var blocks = toolbox.getElementsByTagName('block');
        for (let i = 0, block; block = blocks[i]; i++) {
            prototypes.push(block.getAttribute('type'));
        }

        for (var i = 0; i < prototypes.length; i++) {
            var prototype = prototypes[i];
            var block = workspace.newBlock(prototype);
            block.initSvg();
            block.getSvgRoot().setAttribute('transform', 'translate(' +
                Math.round(Math.random() * 40 + 20) + ', ' +
                Math.round(Math.random() * 40 + i * 10) + ')');
            block.render();
        }
    }

</script>
  <style>
    html, body {
      height: 100%;
    }
    body {
      background-color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    h1 {
      text-align: center;
      font-weight: normal;
      font-size: 150%;
    }
    h2 {
      text-align: center;
      font-weight: normal;
      font-size: 125%;
    }
    #dd-log{
      height: 50%;
      overflow-y: scroll;
      overflow-x: hidden;
    }
    #blocklyDiv {
      float: right;
      height: 95%;
      width: 70%;
    }
    #importExport {
      font-family: monospace;
    }
  </style>
</head>
<html>
<body onload="start()">

  <div id="blocklyDiv"></div>

  <h1>Blockly Playground</h1>

  <p><a href="javascript:void(workspace.setVisible(true))">Show</a>
   - <a href="javascript:void(workspace.setVisible(false))">Hide</a></p>

  <form id="options">
    <select name="dir" onchange="document.forms.options.submit()">
      <option value="ltr">LTR</option>
      <option value="rtl">RTL</option>
    </select>
    <select name="toolbox" onchange="document.forms.options.submit()">
      <option value="simple">Simple</option>
      <!--option value="categories">Categories</option-->
    </select>
    <select name="side" onchange="document.forms.options.submit()">
      <option value="start">Start</option>
      <option value="end">End</option>
      <option value="top">Top</option>
      <option value="bottom">Bottom</option>
    </select>
  </form>

  <p>
    <input type="button" value="Export to XML" onclick="toXml()">
    &nbsp;
    <input type="button" value="Import from XML" onclick="fromXml()" id="import">
    <br>
    <input type="button" value="To JavaScript" onclick="toCode('JavaScript')">
    &nbsp;
    <input type="button" value="To Python" onclick="toCode('Python')">
    &nbsp;
    <input type="button" value="To PHP" onclick="toCode('PHP')">
    &nbsp;
    <input type="button" value="To Lua" onclick="toCode('Lua')">
    &nbsp;
    <input type="button" value="To Dart" onclick="toCode('Dart')">
    <br>
    <textarea id="importExport" style="width: 29%; max-width: 29%; height: 12em; max-height: 20em;"
      onchange="taChange();" onkeyup="taChange()"></textarea>
  </p>
  <h2>
    Stress test
  </h2>
  
  <p>
    <input type="button" value="Airstrike!" onclick="airstrike(100)">
    <br/><input type="button" value="Spaghetti!" onclick="spaghetti(8)">
    <br/><input type="button" value="Fake some drags!" onclick="fakeManyDrags()">
    <br/><input type="button" value="Make ALL the blocks!" onclick="placeAll()">
  </p>
<hr/>
  <h2>
    Output
  </h2>
  <p>
    <input type="checkbox" onclick="logEvents(this.checked)" id="logCheck"> Log block events
  </p>
  <hr/>
    <div id="dd-log">
    </div>
  <hr/>
</body>

</html>
